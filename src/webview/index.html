<!DOCTYPE html><html lang="en">
                <head>
                <meta charset="UTF-8">
                 <meta http-equiv="Content-Security-Policy" 
          content="default-src ${{srchost}}; 
           style-src 'unsafe-inline' 'unsafe-eval' *;
                  frame-src ${{srchost}};
                  script-src 'unsafe-inline' vscode-resource:;">
                <style>html, body {height: 100%;margin: 0;padding: 0;overflow: hidden;} iframe {border: none;width: 100%;height: 100%;}</style>
                </head>
                <body>
<div class="properties-panel-container" style="display: flex; width: 100%; height: 100vh; overflow: hidden;">
  <div class="properties-panel" style="background: #f8f9fa; border-right: 1px solid #dee2e6; width: 20%; min-width: 20px; height: 100%; overflow-y: auto; transition: all 0.3s ease;">
    <button id="toggleBtn" style="margin: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.875rem; border-radius: 0.2rem; background: #6c757d; color: white; border: none; cursor: pointer;">◄</button>
    <select id="lstcomp" ></select>
    <div id="propertiesEditor" style="padding: 1rem;"></div>
  </div>
  <div class="content-panel" style="width: 80%; height: 100%; overflow: auto;">
                <iframe id="mysphpIframe" src="${{url}}"></iframe></div></div>
                <script type="text/javascript">
   (function() {              
const vscode = acquireVsCodeApi();
        const iframe = document.getElementById('mysphpIframe');
        const iframeOrigin = '${{srchost}}';
        const webviewHost = '${{webviewHost}}';

    function sendToVSC(evt,evtp="",bdata={}) {
            var message = {
                command: 'sendToVS',
                ctrl: "",
                evt: evt,
                evtp: evtp,
                bdata: bdata
            };
                        
            try {
                vscode.postMessage(message);
            } catch (error) {
                console.error('Failed to send message VSC:' + error);
            }
        }

        var currentTempComps = {};
        // Handle messages from iframe
        window.addEventListener('message', (event) => {
           if (event.data.command == "sendToVS") {
            if(event.data.evt === "fillcomplist"){
                const select = document.getElementById('lstcomp');
                currentTempComps = event.data.bdata;
                select.innerHTML = '';
                for (const key in event.data.bdata) {
                    const option = document.createElement('option');
                    option.text = key;
                    if(key === event.data.evtp){
                        option.setAttribute("selected", "selected");                        
                    }
                    select.add(option);
                }
            }else{
                vscode.postMessage(event.data);
            }
            }else if (event.data.command == "sendToWV") {
                if(event.data.evt === "reload"){
                    iframe.src = iframe.src.split('?')[0] + '?t=' + Date.now();
                }else if(event.data.evt === "compclick"){
                    renderProp(event.data.evtp,event.data.bdata);
                }else{
                    sendToIframe(event.data.ctrl,event.data.evt,event.data.evtp,event.data.bdata);
                }
            }
               
        },false);

        function sendToIframe(ctrl="",evt="",evtp="",bdata={}){
            var message = {
                command: 'sendToIframe',
                ctrl: ctrl,
                evt: evt,
                evtp: evtp,
                bdata: bdata
            };
            iframe.contentWindow.postMessage(message, iframeOrigin);
        }

        // Initialize communication
        iframe.addEventListener('load', () => {
        setTimeout(() => { 
        sendToIframe('vs','init',webviewHost); 
        }, 1000);
        });
let propertiesPanel = document.querySelector('.properties-panel');
let contentPanel = document.querySelector('.content-panel');
let toggleBtn = document.getElementById('toggleBtn');
lstcomp = document.getElementById('lstcomp');

function renderProp(properties,availableProps) {
    const sedt = properties.attr;
    const sedtp = properties.info;
    const title = sedtp.phpclass;    
    renderPropertiesEditor(sedt,availableProps,title, function(updatedProps) {
        //console.log(sedtp);
        sendToVSC("updateatr",updatedProps,sedtp);
        
        if(sedtp.phpclass !== "HtmlTag"){
          sedtp.id = updatedProps.id;
        }
          
    });
}
lstcomp.onchange = function() {
    var opt1 = this.options[this.selectedIndex];
    var prop = currentTempComps[opt1.text];
    sendToVSC("compclick",opt1.text,prop);
}
// Toggle panel visibility
toggleBtn.onclick = function() {
    const isCollapsed = propertiesPanel.style.width === '0px';
    propertiesPanel.style.width = isCollapsed ? '20%' : '0px';
    contentPanel.style.width = isCollapsed ? '80%' : '100%';
    toggleBtn.textContent = isCollapsed ? '◄' : '►';
  };

// 2. Function to render/update properties editor
function renderPropertiesEditor(properties, availableProps, title, onChangeCallback) {
  const propertiesEditor = document.getElementById('propertiesEditor');
  if (!propertiesEditor) return;

  // Clear previous content
  propertiesEditor.innerHTML = '';
  
  // Add title
  const titleTag = document.createElement('h4');
  titleTag.textContent = title;
  propertiesEditor.appendChild(titleTag);

  // Create container for both tables
  const container = document.createElement('div');
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  container.style.gap = '1rem';
  container.style.height = '100%';

  // 1. Used Properties Table
  const usedPropsTable = document.createElement('table');
  usedPropsTable.style.width = '100%';
  usedPropsTable.style.borderCollapse = 'collapse';
  
  // Used Properties Header
  const usedHeader = usedPropsTable.createTHead();
  const usedHeaderRow = usedHeader.insertRow();
  usedHeaderRow.style.backgroundColor = '#f8f9fa';
  
  const usedPropHeader = usedHeaderRow.insertCell();
  usedPropHeader.textContent = 'Property';
  usedPropHeader.style.padding = '0.5rem';
  usedPropHeader.style.fontWeight = 'bold';
  
  const usedValueHeader = usedHeaderRow.insertCell();
  usedValueHeader.textContent = 'Value';
  usedValueHeader.style.padding = '0.5rem';
  usedValueHeader.style.fontWeight = 'bold';

  // Used Properties Body (scrollable)
  const usedBody = usedPropsTable.createTBody();
  usedBody.style.maxHeight = '200px';
  usedBody.style.overflowY = 'auto';

  // 2. Available Properties Table
  const availPropsTable = document.createElement('table');
  availPropsTable.style.width = '100%';
  availPropsTable.style.borderCollapse = 'collapse';
  
  // Available Properties Header
  const availHeader = availPropsTable.createTHead();
  const availHeaderRow = availHeader.insertRow();
  availHeaderRow.style.backgroundColor = '#f8f9fa';
  
  const availPropHeader = availHeaderRow.insertCell();
  availPropHeader.textContent = '';
  availPropHeader.style.padding = '0.5rem';
  availPropHeader.style.fontWeight = 'bold';
  var spn1 = document.createElement('span');
  spn1.textContent = 'fui';
  availPropHeader.appendChild(spn1);
  var chk1 = document.createElement('input');
  chk1.name = 'chkfun';
  chk1.type = 'radio';
  chk1.value = 'fui';
  availPropHeader.appendChild(chk1);
  spn1 = document.createElement('span');
  spn1.textContent = 'fun';
  availPropHeader.appendChild(spn1);
  var chk1 = document.createElement('input');
  chk1.name = 'chkfun';
  chk1.type = 'radio';
  chk1.value = 'fun';
  chk1.checked = true;
  availPropHeader.appendChild(chk1);
  spn1 = document.createElement('span');
  spn1.textContent = 'fur';
  availPropHeader.appendChild(spn1);
  var chk1 = document.createElement('input');
  chk1.name = 'chkfun';
  chk1.type = 'radio';
  chk1.value = 'fur';
  availPropHeader.appendChild(chk1);

  // Available Properties Body (scrollable)
  const availBody = availPropsTable.createTBody();
  availBody.style.display = 'block';
  availBody.style.maxHeight = '200px';
  availBody.style.overflowY = 'auto';

  // Function to move property between tables
  const moveProperty = (propName, fromTable, toTable, isNew = false) => {
    const row = fromTable.querySelector(`tr[data-prop="${propName}"]`);
    if (row) fromTable.removeChild(row);
    
    if (toTable === usedBody) {
      const newRow = usedBody.insertRow();
      newRow.dataset.prop = propName;
      
      const propCell = newRow.insertCell();
      propCell.textContent = propName;
      propCell.style.padding = '0.3rem';
      
      const valueCell = newRow.insertCell();
      const input = document.createElement('input');
      input.type = 'text';
      input.value = isNew ? '' : properties[propName];
      input.style.width = '100%';
      input.style.padding = '0.2rem';
      input.style.border = '1px solid #ddd';
      input.dataset.property = propName;
      
      input.addEventListener('input', function() {
        clearTimeout(this._timer);
        this._timer = setTimeout(() => {
          properties[this.dataset.property] = this.value;
          if (onChangeCallback) onChangeCallback(properties);
        }, 1400);
      });
      
      valueCell.appendChild(input);
      valueCell.style.padding = '0.3rem';
    } else {
      const newRow = availBody.insertRow();
      newRow.dataset.prop = propName;
      
      const propCell = newRow.insertCell();
      propCell.textContent = propName;
      propCell.style.padding = '0.3rem';
      propCell.colSpan = 2;
      
      newRow.addEventListener('click', () => {
        var v1 = "fun";
        document.getElementsByName('chkfun').forEach(chk => {
          if (chk.checked === true) {
            v1 = chk.value;
          }
        });
        propName = v1 + propName;
        moveProperty(propName, availBody, usedBody, true);
        properties[propName] = '';
        if (onChangeCallback) onChangeCallback(properties);
      });
    }
  };

  // Populate initial tables
  var prop2 = {};
  Object.keys(properties).forEach(prop => {
    var v1 = prop.substring(0, 3);
    if (v1 === 'fui' || v1 === 'fun' || v1 === 'fur') {
        prop2[prop.substring(3)] = properties[prop];
    }else{
        prop2[prop] = properties[prop];
    }
    moveProperty(prop, availBody, usedBody);
  });
  Object.keys(availableProps).forEach(prop => {
    if (!prop2.hasOwnProperty(prop)) {
      moveProperty(prop, usedBody, availBody);
    }
  });

  // Add tables to container
  const usedSection = document.createElement('div');
  usedSection.innerHTML = '<h5>Used Properties</h5>';
  usedSection.appendChild(usedPropsTable);
  
  const availSection = document.createElement('div');
  availSection.innerHTML = '<h5>Available Properties</h5>';
  availSection.appendChild(availPropsTable);
  
  container.appendChild(usedSection);
  container.appendChild(availSection);
  propertiesEditor.appendChild(container);
}
        })();    
</script>
                 
</body>
</html>